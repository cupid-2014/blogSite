### spring boot集成shiro

#### 步骤
* 修改`pom.xml`引入shiro需要的jar包
```xml
    <dependencies>
        ……
        <!-- https://mvnrepository.com/artifact/org.apache.shiro/shiro-spring -->
        <dependency>
            <groupId>org.apache.shiro</groupId>
            <artifactId>shiro-spring</artifactId>
            <version>1.4.0</version>
        </dependency>
        ……
    </dependencies>
```
* 增加shiro的配置类`ShiroConfiguration.java`
```java
    package top.z_f.simpleerp.config.shiro;

    import org.apache.shiro.spring.web.ShiroFilterFactoryBean;
    import org.apache.shiro.web.mgt.DefaultWebSecurityManager;

    import java.util.LinkedHashMap;
    import java.util.Map;

    import org.apache.shiro.mgt.SecurityManager;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;

    /**
    * @author zhangzhen
    *
    */
    @Configuration
    public class ShiroConfiguration {
        
        private static final Logger logger = LoggerFactory.getLogger(ShiroConfiguration.class);

        @Bean
        public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) {
            logger.info("ShiroConfiguration >> shiroFilter :: shiro过滤器配置开始");
            ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
            // 设置安全管理器
            shiroFilterFactoryBean.setSecurityManager(securityManager);
            // 默认跳转到登录页面
            shiroFilterFactoryBean.setLoginUrl("/login");
            // 登录成功后的页面
            shiroFilterFactoryBean.setSuccessUrl("/index");
            // 权限验证失败后跳转页面
            shiroFilterFactoryBean.setUnauthorizedUrl("/404");
            
            // 拦截器
            Map<String, String> filterChainDefinitionMap = new LinkedHashMap<>();
            // 配置不会被拦截的连接，顺序判断
            filterChainDefinitionMap.put("/static/**", "anon");
            // 配置退出 过滤器,其中的具体的退出代码Shiro已经替我们实现了
            filterChainDefinitionMap.put("/logout", "logout");
            //<!-- 过滤链定义，从上向下顺序执行，一般将/**放在最为下边 -->:这是一个坑呢，一不小心代码就不好使了;
            //<!-- authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问-->
            filterChainDefinitionMap.put("/**", "authc");
            shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
            
            logger.info("ShiroConfiguration >> shiroFilter :: shiro过滤器配置结束");
            return shiroFilterFactoryBean;
        }
        
        /**
        * 身份认证Realm，此处的注入不可以缺少。否则会在UserShiroRealm中注入对象会报空指针.
        * @return
        */
        @Bean
        public UserShiroRealm userShiroRealm() {
            UserShiroRealm userShiroRealm = new UserShiroRealm();
            return userShiroRealm;
        }
        
        /**
        * 核心的安全事务管理器
        * @return
        */
        @Bean
        public SecurityManager securityManager() {
            DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
            securityManager.setRealm(userShiroRealm());
            return securityManager;
        }
    }
```
* 自定义Realm类
```java
    package top.z_f.simpleerp.config.shiro;

    import java.util.List;

    import org.apache.shiro.authc.AuthenticationException;
    import org.apache.shiro.authc.AuthenticationInfo;
    import org.apache.shiro.authc.AuthenticationToken;
    import org.apache.shiro.authc.SimpleAuthenticationInfo;
    import org.apache.shiro.authc.UnknownAccountException;
    import org.apache.shiro.authz.AuthorizationInfo;
    import org.apache.shiro.authz.SimpleAuthorizationInfo;
    import org.apache.shiro.realm.AuthorizingRealm;
    import org.apache.shiro.subject.PrincipalCollection;
    import org.apache.shiro.util.ByteSource;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;
    import org.springframework.beans.factory.annotation.Autowired;

    import top.z_f.simpleerp.entity.SysUser;
    import top.z_f.simpleerp.entity.SysUserRoleKey;
    import top.z_f.simpleerp.service.SysUserRoleService;
    import top.z_f.simpleerp.service.SysUserService;

    /**
    * 
    * 声明用于管理台用户验证的自定义Realm类
    * @author zhangzhen
    *
    */
    public class ManagerUserShiroRealm extends AuthorizingRealm {
        
        private static final Logger logger = LoggerFactory.getLogger(ManagerUserShiroRealm.class);
        
        @Autowired
        SysUserService sysUserService;
        @Autowired
        SysUserRoleService sysUserRoleService;

        /**
        * 提供用户信息，返回权限信息
        * @param principalCollection
        * @return
        */
        @Override
        protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
            logger.info("UserShiroRealm >> doGetAuthenticationInfo :: 授权验证");
            SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();
            SysUser userInfo  = (SysUser)principalCollection.getPrimaryPrincipal();
            List<SysUserRoleKey> roleList = sysUserRoleService.findRoleByUserId(userInfo.getId());
            for(SysUserRoleKey userRole : roleList){
                authorizationInfo.addRole(userRole.getSysRoleid());
            }
            return authorizationInfo;
        }

        /**
        * 提供帐户信息，返回认证信息
        * @param authenticationToken
        * @return
        * @throws AuthenticationException
        */
        @Override
        protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
            logger.info("UserShiroRealm >> doGetAuthenticationInfo :: 登录验证");
            // 获取用户输入的账号
            String mobile = (String)authenticationToken.getPrincipal();
            //通过userName从数据库中查找 ，如果找不到抛出异常
            //实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法
            SysUser userInfo = sysUserService.findUserByMobile(mobile);
            System.out.println("userInfo ----->> " + userInfo);
            if(userInfo == null){
                //用户不存在就抛出异常
                throw new UnknownAccountException();
            }
            //此处是获取数据库内的账号、密码、盐值，保存到登陆信息info中
            SimpleAuthenticationInfo authenticationInfo = new SimpleAuthenticationInfo(
                    userInfo.getMobile(),
                    userInfo.getPassword(),
    //        		ByteSource.Util.bytes(userInfo.getSalt()), // 加盐
                    null, // 不加盐
                    getName() //realm name
            );
            return authenticationInfo;
        }

    }
```
* 登录编写（主体不变，具体根据需要进行修改）
```java
@RequestMapping("/login")
	public String login(@RequestParam(name="userName", required = false, defaultValue="") String userName, 
			@RequestParam(name="password", required = false, defaultValue="") String password, 
			Model model) { 
		logger.info("WebController.login()");
		// 判断是否为真正的登录（用户名和密码必须不能为空）
		if ("".equals(userName) || "".equals(password))
			return "login_register/login";

		// 调用shiro用户验证
        UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(userName, password);
        Subject subject = SecurityUtils.getSubject();
        try {
              subject.login(usernamePasswordToken);
        }catch (IncorrectCredentialsException ice){
             model.addAttribute("error","password error");
             logger.error("IncorrectCredentialsException ：" + ice.getMessage());
             return "errors/error";
        }catch (UnknownAccountException uae) {
        	logger.error("UnknownAccountException ：" + uae.getMessage());
            model.addAttribute("error","userName error");
            return "errors/500";
        }catch (ExcessiveAttemptsException eae) {
        	logger.error("ExcessiveAttemptsException ：" + eae.getMessage());
            model.addAttribute("error","time error");
            return "errors/500";
        }

        model.addAttribute("userName", userName);
        model.addAttribute("context", "TODO");
		return "index";
	}
```
* 启动程序，用其他url看是否会跳转到login页面

#### 参考文档
* [Shiro](https://www.cnblogs.com/maofa/p/6407102.html)
* [Spring Boot 整合 Shiro-登录认证和权限管理](http://www.ityouknow.com/springboot/2017/06/26/spring-boot-shiro.html)
* [SpringBoot集成Shiro](https://www.cnblogs.com/expiator/p/8651798.html)
* [login demo](https://github.com/firefoxer1992/SpringBootProject/blob/master/src/main/java/com/example/demo/controller/LoginController.java)

[首页](../../README.md) [上一篇：spring boot中Controller获取前台参数方式](201906003.md) 下一篇： [Java](java.md)
